<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>제작사례 - 드림전동차</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <!-- GNB -->
    <header class="gnb" id="gnb">
        <a href="index.html" class="gnb-logo">드림<span>전동차</span></a>
        <nav>
            <ul class="gnb-nav">
                <li><a href="index.html">홈</a></li>
                <li><a href="about.html">브랜드 스토리</a></li>
                <li><a href="index.html#best-sellers">대표모델</a></li>
                <li><a href="cases.html">제작사례</a></li>
                <li><a href="index.html#contact">고객지원</a></li>
            </ul>
        </nav>
        <a href="index.html#contact" class="gnb-cta">견적문의</a>
    </header>

    <!-- 2x2 Category Nav -->
    <section class="section cases-hero">
        <h2 class="section-title">제작 <span>사례</span></h2>
        <p style="text-align: center; margin-bottom: 1.5rem;">
            <button type="button" class="btn-spec" id="filterAll">전체 보기</button>
        </p>
        <div class="category-grid" id="categoryNav">
            <div class="category-box" data-filter="industrial">
                <div class="category-box-bg" style="background-image: url('images/industrial.webp');"></div>
                <div class="category-box-overlay"><span>산업용 전동차</span></div>
            </div>
            <div class="category-box" data-filter="agricultural">
                <div class="category-box-bg" style="background-image: url('images/farm.webp');"></div>
                <div class="category-box-overlay"><span>농업용 전동차</span></div>
            </div>
            <div class="category-box" data-filter="multipurpose">
                <div class="category-box-bg" style="background-image: url('images/main2.webp');"></div>
                <div class="category-box-overlay"><span>다목적 전동차</span></div>
            </div>
            <div class="category-box" data-filter="custom">
                <div class="category-box-bg" style="background-image: url('images/custom.webp');"></div>
                <div class="category-box-overlay"><span>맞춤제작 전동차</span></div>
            </div>
        </div>

        <!-- Gallery -->
        <div class="gallery" id="gallery">
            <div class="gallery-item" data-category="industrial">
                <img src="images/industrial.webp" alt="산업용 전동차 사례 1" loading="lazy">
            </div>
            <div class="gallery-item" data-category="industrial">
                <img src="images/industrial.webp" alt="산업용 전동차 사례 2" loading="lazy">
            </div>
            <div class="gallery-item" data-category="agricultural">
                <img src="images/farm.webp" alt="농업용 사례 1" loading="lazy">
            </div>
            <div class="gallery-item" data-category="agricultural">
                <img src="images/farm.webp" alt="농업용 사례 2" loading="lazy">
            </div>
            <div class="gallery-item" data-category="multipurpose">
                <img src="images/main2.webp" alt="다목적 사례 1" loading="lazy">
            </div>
            <div class="gallery-item" data-category="multipurpose">
                <img src="images/main2.webp" alt="다목적 사례 2" loading="lazy">
            </div>
            <div class="gallery-item" data-category="custom">
                <img src="images/custom.webp" alt="맞춤제작 사례 1" loading="lazy">
            </div>
            <div class="gallery-item" data-category="custom">
                <img src="images/custom.webp" alt="맞춤제작 사례 2" loading="lazy">
            </div>
            <div class="gallery-item" data-category="industrial">
                <img src="images/industrial.webp" alt="산업용 전동차 사례 3" loading="lazy">
            </div>
            <div class="gallery-item" data-category="agricultural">
                <img src="images/farm.webp" alt="농업용 사례 3" loading="lazy">
            </div>
        </div>
    </section>

    <!-- Modal Popup -->
    <div id="caseModal" class="case-modal">
        <div class="case-modal-overlay"></div>
        <div class="case-modal-content">
            <button class="case-modal-close" id="modalClose">&times;</button>
            <div class="case-modal-image-wrap">
                <img id="modalImage" src="" alt="" class="case-modal-image">
            </div>
            <div class="case-modal-body">
                <div class="case-modal-header">
                    <span id="modalCategory" class="case-modal-category"></span>
                    <h3 id="modalTitle" class="case-modal-title"></h3>
                </div>
                <div id="modalContent" class="case-modal-text"></div>
            </div>
        </div>
    </div>

    <footer id="contact">
        <p>© 드림전동차. All rights reserved.</p>
    </footer>

    <script src="js/script.js"></script>
    <script>
        // GNB scroll
        (function() {
            var gnb = document.getElementById('gnb');
            if (!gnb) return;
            function onScroll() { gnb.classList.toggle('scrolled', window.scrollY > 50); }
            window.addEventListener('scroll', onScroll);
            onScroll();
        })();

        // Load CMS cases data
        (function() {
            var gallery = document.getElementById('gallery');
            if (!gallery) return;

            // Category mapping: 한글 -> 영문
            var categoryMap = {
                '산업용': 'industrial',
                '농업용': 'agricultural',
                '다목적': 'multipurpose',
                '맞춤제작': 'custom'
            };

            // Parse frontmatter from markdown content
            function parseFrontmatter(content) {
                var frontmatter = {};
                var body = '';
                var match = content.match(/^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/);
                if (match) {
                    var fmText = match[1];
                    body = match[2] || '';
                    var lines = fmText.split('\n');
                    lines.forEach(function(line) {
                        var colonIndex = line.indexOf(':');
                        if (colonIndex > 0) {
                            var key = line.substring(0, colonIndex).trim();
                            var value = line.substring(colonIndex + 1).trim().replace(/^["']|["']$/g, '');
                            frontmatter[key] = value;
                        }
                    });
                }
                frontmatter.body = body;
                return frontmatter;
            }

            // Create gallery item from CMS data
            function createGalleryItem(data) {
                var item = document.createElement('div');
                item.className = 'gallery-item';
                item.setAttribute('data-category', data.category);
                // Store case data for modal
                item.setAttribute('data-case-title', data.title || '');
                item.setAttribute('data-case-category', data.categoryLabel || '');
                item.setAttribute('data-case-image', data.image || '');
                item.setAttribute('data-case-body', data.body || '');
                
                var img = document.createElement('img');
                img.src = data.image;
                img.alt = data.title || '제작사례';
                img.loading = 'lazy';
                
                item.appendChild(img);
                
                // Add click event
                item.addEventListener('click', function() {
                    openCaseModal(data);
                });
                
                return item;
            }

            // Load cases from GitHub
            function loadCases() {
                // GitHub API: Get folder contents
                var apiUrl = 'https://api.github.com/repos/dreamev5031/dreamev/contents/public/content/cases';
                
                fetch(apiUrl)
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error('Failed to load cases');
                        }
                        return response.json();
                    })
                    .then(function(files) {
                        // Filter markdown files
                        var mdFiles = files.filter(function(file) {
                            return file.type === 'file' && file.name.endsWith('.md');
                        });

                        if (mdFiles.length === 0) {
                            console.log('No CMS cases found');
                            return;
                        }

                        // Load each markdown file
                        var promises = mdFiles.map(function(file) {
                            return fetch(file.download_url)
                                .then(function(response) { return response.text(); })
                                .then(function(content) {
                                    var frontmatter = parseFrontmatter(content);
                                    var category = categoryMap[frontmatter.category] || frontmatter.category.toLowerCase();
                                    
                                    return {
                                        title: frontmatter.title || '',
                                        category: category,
                                        categoryLabel: frontmatter.category || '',
                                        image: frontmatter.image || '',
                                        date: frontmatter.date || '',
                                        body: frontmatter.body || ''
                                    };
                                })
                                .catch(function(err) {
                                    console.error('Error loading file:', file.name, err);
                                    return null;
                                });
                        });

                        Promise.all(promises)
                            .then(function(cases) {
                                // Filter out null values
                                cases = cases.filter(function(c) { return c && c.image; });
                                
                                // Create gallery items and prepend to gallery (CMS items appear first)
                                cases.forEach(function(caseData) {
                                    var item = createGalleryItem(caseData);
                                    gallery.insertBefore(item, gallery.firstChild);
                                });

                                // Update filter to include new CMS items
                                if (window.filterGallery) {
                                    window.filterGallery(window.currentFilter || 'all');
                                }
                            })
                            .catch(function(err) {
                                console.error('Error processing cases:', err);
                            });
                    })
                    .catch(function(err) {
                        console.error('Error loading cases from GitHub:', err);
                    });
            }

            // Load cases on page load
            loadCases();
        })();

        // Modal functionality
        (function() {
            var modal = document.getElementById('caseModal');
            var modalClose = document.getElementById('modalClose');
            var modalImage = document.getElementById('modalImage');
            var modalCategory = document.getElementById('modalCategory');
            var modalTitle = document.getElementById('modalTitle');
            var modalContent = document.getElementById('modalContent');
            var modalOverlay = modal ? modal.querySelector('.case-modal-overlay') : null;

            // Open modal with case data
            window.openCaseModal = function(caseData) {
                if (!modal) return;
                
                modalImage.src = caseData.image || '';
                modalImage.alt = caseData.title || '제작사례';
                modalTitle.textContent = caseData.title || '제작사례';
                modalCategory.textContent = caseData.categoryLabel || '';
                
                // Convert markdown to HTML
                var bodyContent = caseData.body || '';
                if (bodyContent && typeof marked !== 'undefined') {
                    modalContent.innerHTML = marked.parse(bodyContent);
                } else {
                    // Fallback: simple markdown-like conversion
                    modalContent.innerHTML = '<p>' + bodyContent.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>') + '</p>';
                }
                
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            };

            // Close modal
            function closeModal() {
                if (!modal) return;
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }

            // Close button
            if (modalClose) {
                modalClose.addEventListener('click', closeModal);
            }

            // Overlay click
            if (modalOverlay) {
                modalOverlay.addEventListener('click', closeModal);
            }

            // ESC key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal && modal.classList.contains('active')) {
                    closeModal();
                }
            });

            // Add click events to existing gallery items
            var existingItems = document.querySelectorAll('.gallery-item');
            existingItems.forEach(function(item) {
                item.addEventListener('click', function() {
                    var img = item.querySelector('img');
                    if (img) {
                        window.openCaseModal({
                            title: img.alt || '제작사례',
                            categoryLabel: '제작사례',
                            image: img.src,
                            body: ''
                        });
                    }
                });
            });
        })();
    </script>
</body>
</html>
